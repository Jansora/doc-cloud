# 9. 部署 Dashboard

import {Callout} from "nextra-theme-docs";

<Callout type="warning" emoji="⚠️">
    Master 节点安装
</Callout>

先部署metrics-server：

```
wget https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.6.3/components.yaml

```

修改components.yaml中的image为docker.io/unreachableg/k8s.gcr.io_metrics-server_metrics-server:v0.6.3。 修改components.yaml中容器的启动参数，加入--kubelet-insecure-tls。


```
kubectl apply -f components.yaml

```
metrics-server的pod正常启动后，等一段时间就可以使用kubectl top查看集群和pod的metrics信息:

```
kubectl top node
NAME    CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
node1   509m         12%    3654Mi          47%
node2   133m         3%     1786Mi          23%
node3   117m         2%     1810Mi          23%

kubectl top pod -n kube-system
NAME                               CPU(cores)   MEMORY(bytes)
coredns-74586cf9b6-575nl           6m           16Mi
coredns-74586cf9b6-mbn8s           5m           17Mi
etcd-node1                         49m          91Mi
kube-apiserver-node1               142m         490Mi
kube-controller-manager-node1      38m          54Mi
kube-proxy-k5lzs                   26m          19Mi
kube-proxy-rb5pf                   9m           15Mi
kube-proxy-w5zpk                   27m          16Mi
kube-scheduler-node1               7m           18Mi
metrics-server-8dfd488f5-r8pbh     8m           21Mi
tigera-operator-5fb55776df-wxbph   10m          38Mi
```



## helm 安装 Dashboard
添加chart repo:
```
helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
```

```
root@master:/etc/kubernetes/conf/nfs# helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
NAME: kubernetes-dashboard
LAST DEPLOYED: Fri May 12 07:25:41 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
*********************************************************************************
*** PLEASE BE PATIENT: kubernetes-dashboard may take a few minutes to install ***
*********************************************************************************

Get the Kubernetes Dashboard URL by running:
  export POD_NAME=$(kubectl get pods -n default -l "app.kubernetes.io/name=kubernetes-dashboard,app.kubernetes.io/instance=kubernetes-dashboard" -o jsonpath="{.items[0].metadata.name}")
  echo https://127.0.0.1:8443/
  kubectl -n default port-forward $POD_NAME 8443:8443
```
# 配置转发
### 第一种方式
使用 port-forward 转发 (临时方案, 需要阻塞终端)
```
 kubectl -n default port-forward $POD_NAME 30443:8443 --address 0.0.0.0
```
### 第二种方式
调整 Service kubernetes-dashboard

从 ClusterIP 转化为 NodePort , 新增 `nodePort: 30843`
```
kubectl edit service kubernetes-dashboard
```
```
apiVersion: v1
kind: Service
metadata:
  ...
spec:
  ports:
  - name: https
    nodePort: 30843
    port: 443
    protocol: TCP
    ...
  ...
  type: NodePort
```

创建管理员sa:

```
kubectl create serviceaccount kube-dashboard-admin-sa -n kube-system

kubectl create clusterrolebinding kube-dashboard-admin-sa \
--clusterrole=cluster-admin --serviceaccount=kube-system:kube-dashboard-admin-sa

```
创建集群管理员登录dashboard所需token:

```
kubectl create token kube-dashboard-admin-sa -n kube-system --duration=87600h

eyJhbGciOiJSUzI1NiIsImtpZCI6IlU1SlpSTS1YekNuVzE0T1k5TUdTOFFqN25URWxKckt6OUJBT0xzblBsTncifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxOTY4OTA4MjgyLCJpYXQiOjE2NTM1NDgyODIsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJrdWJlLWRhc2hib2FyZC1hZG1pbi1zYSIsInVpZCI6IjY0MmMwMmExLWY1YzktNDFjNy04Mjc5LWQ1ZmI3MGRjYTQ3ZSJ9fSwibmJmIjoxNjUzNTQ4MjgyLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06a3ViZS1kYXNoYm9hcmQtYWRtaW4tc2EifQ.Xqxlo2vJ9Hb6UUVIqwvc8I5bahdxKzSRSaQI_67Yt7_YEHmkkHApxUGlwJYTKF9ufww3btlCmM8PtRn5_Q1yv-HAFyTOYKo8WHZ9UCm1bT3X8V8g4GQwZIl2dwmlUmKb1unBz2-em2uThQ015bMPDE8a42DV_bOwWjljVXat0nwV14nGorC8vKLjXbohrIJ3G1pgCJvlBn99F1RelmSUSQLlolUFoxpN6MamYTElwR6FfD-AGmFXvZSbcFaqVW0oxJHV70Gjs2igOtpqHFxxPlHT8aQzlRiybPtFyBf9Ll87TmVJimT89z8wv2si2Nee8bB2jhsApLn8TJyUSlbTXA

```

## 配置 nginx 转发

> 注意 proxy_pass 的协议是 https


```

server {
    listen 443 ssl http2;
    server_name kubernetes.fabric.jansora.com;
    ssl_protocols    TLSv1 TLSv1.1 TLSv1.2;
    ssl_certificate     /etc/nginx/certs/lets-encrypt-jansora.com/jansora.com.cer;
    ssl_certificate_key /etc/nginx/certs/lets-encrypt-jansora.com/jansora.com.key;
    location / {
        proxy_pass_header Server;
        proxy_redirect off;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection upgrade;
        proxy_pass https://192.168.88.101:30843/;
    }
}
```

喜闻悦见
[https://kubernetes.fabric.jansora.com](https://kubernetes.fabric.jansora.com)
![lBc5i7](https://cdn.jansora.com/files/uPic/2023/09/21/lBc5i7.png)
