# 9. 部署 Dashboard

import {Callout} from "nextra-theme-docs";

<Callout type="warning" emoji="⚠️">
    U1 节点安装
</Callout>



## helm 安装 Dashboard

```
helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
```

record ...

```
root@u1:/etc/kubernetes/conf/nfs# helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard
NAME: kubernetes-dashboard
LAST DEPLOYED: Fri May 12 07:25:41 2023
NAMESPACE: default
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
*********************************************************************************
*** PLEASE BE PATIENT: kubernetes-dashboard may take a few minutes to install ***
*********************************************************************************

Get the Kubernetes Dashboard URL by running:
  export POD_NAME=$(kubectl get pods -n default -l "app.kubernetes.io/name=kubernetes-dashboard,app.kubernetes.io/instance=kubernetes-dashboard" -o jsonpath="{.items[0].metadata.name}")
  echo https://127.0.0.1:8443/
  kubectl -n default port-forward $POD_NAME 8443:8443
```
# 配置转发
### 第一种方式
使用 port-forward 转发 (临时方案, 需要阻塞终端)
```
 kubectl -n default port-forward $POD_NAME 30443:8443 --address 0.0.0.0
```
### 第二种方式
调整 service kubernetes-dashboard
从 ClusterIP 转化为 NodePort
```
kubectl edit service kubernetes-dashboard
```
```
apiVersion: v1
kind: Service
metadata:
  ...
spec:
  ports:
  - name: https
    ...
    nodePort: 30443
  ...
  type: NodePort
```

获取登录密钥

```
kubectl describe secret $(kubectl get secret  | grep kubernetes-dashboard-token | awk '{print $1}')
```

# 配置 nginx 转发

> 注意 proxy_pass 的协议是 https


```
server {
    listen 443 ssl http2;
    server_name  kubernetes.jansora.com;

    ssl_protocols    TLSv1 TLSv1.1 TLSv1.2;
    ssl_certificate     /etc/nginx/certs/lets-encrypt-jansora.com/jansora.com.cer;
    ssl_certificate_key /etc/nginx/certs/lets-encrypt-jansora.com/jansora.com.key;

    location / {
          proxy_pass_header Server;
          proxy_set_header Host $http_host;
          proxy_redirect off;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Scheme $scheme;
          proxy_pass https://192.168.88.11:30443;
    }
}
```

喜闻悦见
[https://kubernetes.jansora.com](https://kubernetes.jansora.com)
![image.png](https://cdn.jansora.com/application/Jansora/2022/10/25/05:05:59/image.png#id=Q0Ppk&originHeight=1310&originWidth=3238&originalType=binary&ratio=1&rotation=0&showTitle=true&status=done&style=none&title=image.png "image.png")
# 等等. 还需要配置 dashboard 权限
否则页面是空的
> namespace 默认是 default 请根据实际的填写

`vim dashboard-admin.yaml`

```
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kubernetes-dashboard
  namespace: default
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: kubernetes-dashboard
    namespace: default
```
`kubectl apply -f dashboard-admin.yaml`
# 调整dashboard token 失效期
默认的 dashboard token 好像是 10 分钟.
从 dashboard web ui 编辑 dashboard deployment yaml
![image.png](https://cdn.nlark.com/yuque/0/2022/png/234270/1672103605102-a6e6d26d-c94a-48d0-8c2e-44d07bf02103.png#averageHue=%231d1d1d&clientId=u8da0c265-7735-4&from=paste&height=602&id=u552fa3f4&originHeight=1204&originWidth=3666&originalType=binary&ratio=1&rotation=0&showTitle=false&size=287629&status=done&style=none&taskId=u9ea7dbbf-c08c-455f-b63e-7f046dbab20&title=&width=1833)
调整 args `--token-ttl=3153600000` 点 Update
![image.png](https://cdn.nlark.com/yuque/0/2022/png/234270/1672103523742-929914eb-492a-4f61-a318-dec9d3582656.png#averageHue=%23232222&clientId=u8da0c265-7735-4&from=paste&height=666&id=u3abd6603&originHeight=1332&originWidth=1890&originalType=binary&ratio=1&rotation=0&showTitle=false&size=246315&status=done&style=none&taskId=u7c494f0c-c333-4561-bdca-bf298ecff9e&title=&width=945)

